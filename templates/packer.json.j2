{
  "builders": [
    {
      "type": "qemu",
      "iso_url": "file:///{{ role_path }}/files/build/{{ lsw_windows_iso }}",
      "iso_checksum": "none",
      "output_directory": "windows_img_dir",
      "format": "{{ lsw_windows_img_format }}",
      "vm_name": "{{ lsw_windows_vm_name }}",
      "accelerator": "kvm",
      "disk_size": "{{ lsw_windows_img_size }}",
      "disk_interface": "virtio-scsi",
      "net_device": "e1000",
      "floppy_files": [
        "autounattend.xml"
      ],
      "qemuargs": [
        ["-cpu", "host,migratable=on,hv-time=on,hv-relaxed=on,hv-vapic=on,hv-spinlocks=0x1fff,hv-vpindex=on,hv-runtime=on,hv-synic=on,hv-stimer=on,hv-frequencies=on,hv-tlbflush=on,hv-ipi=on,hv-evmcs=on,hv-avic=on"],
        ["-drive", "if=none,file=windows_img_dir/{{ lsw_windows_vm_name }},id=drive0,cache=writeback,discard=ignore,format={{ lsw_windows_img_format }}"],
        ["-drive", "file={{ lsw_windows_iso }},media=cdrom"],
        ["-drive", "file={% if lsw_windows_version == 11 and lsw_windows_install_template == 'normal' %}{{ lsw_windows_ovmf_code_secboot_path }}{% else %}{{ lsw_windows_ovmf_code_path }}{% endif %},if=pflash,unit=0,format={% if ansible_facts['lsb']['id'] == 'NobaraLinux' %}qcow2{% else %}raw{% endif %},readonly=on"],
        ["-drive", "file=windows_img_dir/efivars.fd,if=pflash,unit=1,format=raw"],
        ["-drive", "file=virtio/virtio-win.iso,media=cdrom"],
        ["-drive", "file=extra_packages/packages.iso,media=cdrom"],
{% if lsw_windows_version == 11 and lsw_windows_install_template == 'normal' %}
        ["-device", "driver=tpm-crb,tpmdev=tpm0,id=tpm0"],
{% endif %}
        ["-device", "virtio-scsi-pci,id=scsi0"],
        ["-device", "scsi-hd,bus=scsi0.0,drive=drive0"],
        ["-device", "driver=pcie-root-port,port=16,chassis=1,id=pci.1,bus=pcie.0,multifunction=true,addr=0x3"],
        ["-device", "driver=pcie-root-port,port=17,chassis=2,id=pci.2,bus=pcie.0,addr=0x3.0x1"],
        ["-device", "driver=pcie-root-port,port=18,chassis=3,id=pci.3,bus=pcie.0,addr=0x3.0x2"],
        ["-device", "driver=pcie-root-port,port=19,chassis=4,id=pci.4,bus=pcie.0,addr=0x3.0x3"],
        ["-device", "driver=pcie-root-port,port=20,chassis=5,id=pci.5,bus=pcie.0,addr=0x3.0x4"],
{% if lsw_virt_mode == 'passthrough' %}
{% for idx in range(_lsw_pci_ids.stdout.split(',') | length) %}
        ["-device", "driver=vfio-pci,host=0000:{{ lsw_passthrough_gpu_pci_base_addr }}.{{ idx }},id=hostdev{{ idx }},bus=pci.{{ 2 + idx }},addr=0x0"]{% if not loop.last %},{% endif %}
{% endfor %}
{% endif %}
{% if lsw_virt_mode == 'gvtg' %}
        ["-device", "driver=vfio-pci,id=hostdev0,sysfsdev=/sys/bus/mdev/devices/65e0c490-1f9f-47e2-87b4-3f3d14255b2f,display=off,bus=pci.2,addr=0x0"]
{% endif %}
{% if lsw_virt_mode == 'sriov' %}
        ["-device", "driver=vfio-pci,id=hostdev0,host=0000:{{ (_lsw_pci_cpu.stdout | split('.'))[0] }}.1,bus=pci.2,addr=0x0"]
{% endif %}
      ],
      "efi_boot": "true",
      "efi_firmware_code": "{% if lsw_windows_version == 11 and lsw_windows_install_template == 'normal' %}{{ lsw_windows_ovmf_code_secboot_path }}{% else %}{{ lsw_windows_ovmf_code_path }}{% endif %}",
      "efi_firmware_vars": "{{ lsw_windows_ovmf_vars_path }}",
{% if lsw_windows_version == 11 and lsw_windows_install_template == 'normal' %}
      "vtpm": "true",
{% endif %}
      "machine_type": "q35",
      "memory": "{{ lsw_windows_build_mem }}",
      "cpus": "{{ lsw_windows_build_num_cpu }}",
      "communicator": "none",
      "pause_before_connecting": "{{ lsw_windows_build_timeout_minutes }}m",
      "shutdown_timeout": "{{ (lsw_windows_build_timeout_minutes + 5) | int }}m"
    }
  ],
  "provisioners": [
  {
    "type": "shell-local",
    "inline": ["echo 'Installing Windows... waiting {{ lsw_windows_build_timeout_minutes }} min'; sleep {{ (lsw_windows_build_timeout_minutes * 60) | int}}"]
  }
]
}
